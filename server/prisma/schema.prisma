generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  email                String         @unique
  password             String         @map("password")
  createdAt            DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  fullName             String?        @map("full_name")
  isActive             Boolean        @default(true) @map("is_active")
  phone                String?
  role                 String
  updatedAt            DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  username             String         @unique
  id                   String         @id @default(uuid()) @db.Uuid
  recordedAttendances  Attendance[]   @relation("RecordedBy")
  centerUsers          CenterUser[]
  gradedAssessments    Grade[]        @relation("GradedBy")
  uploadedMaterials    Material[]     @relation("UploadedBy")
  createdNotifications Notification[] @relation("CreatedBy")
  parent               Parent?
  student              Student?
  teacher              Teacher?

  @@map("users")
}

model Teacher {
  id          String            @id @default(uuid()) @db.Uuid
  userId      String            @unique @map("user_id") @db.Uuid
  centerId    String            @map("center_id") @db.Uuid
  hireDate    DateTime?         @map("hire_date") @db.Date
  contractEnd DateTime?         @map("contract_end") @db.Date
  subjects    String[]
  salary      Decimal?          @db.Decimal(12, 2)
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  classes     Class[]
  contracts   Contract[]
  payrolls    Payroll[]
  documents   TeacherDocument[]
  center      Center            @relation(fields: [centerId], references: [id])
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("teachers")
}

model Student {
  id          String              @id @default(uuid()) @db.Uuid
  userId      String              @unique @map("user_id") @db.Uuid
  centerId    String              @map("center_id") @db.Uuid
  studentCode String?             @unique @map("student_code")
  dateOfBirth DateTime?           @map("date_of_birth") @db.Date
  gender      String?
  address     String?
  createdAt   DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  attendances Attendance[]
  enrollments Enrollment[]
  grades      Grade[]
  parentLinks StudentParentLink[]
  center      Center              @relation(fields: [centerId], references: [id])
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("students")
}

model Parent {
  id           String              @id @default(uuid()) @db.Uuid
  userId       String              @unique @map("user_id") @db.Uuid
  createdAt    DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentLinks StudentParentLink[]

  @@map("parents")
}

model StudentParentLink {
  id             BigInt  @id @default(autoincrement())
  studentId      String  @map("student_id") @db.Uuid
  parentId       String  @map("parent_id") @db.Uuid
  relation       String?
  primaryContact Boolean @default(false) @map("primary_contact")
  parent         Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student        Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_parent_links")
}

model Center {
  id            String         @id @default(uuid()) @db.Uuid
  name          String?
  address       String?
  contactEmail  String?        @map("contact_email")
  contactPhone  String?        @map("contact_phone")
  timezone      String?
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  alerts        Alert[]
  centerUsers   CenterUser[]
  courses       Course[]
  notifications Notification[]
  rooms         Room[]
  students      Student[]
  teachers      Teacher[]

  @@map("centers")
}

model CenterUser {
  id        BigInt   @id @default(autoincrement())
  centerId  String   @map("center_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  center    Center   @relation(fields: [centerId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("center_users")
}

model Subject {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  name        String?
  description String?
  courses     Course[]

  @@map("subjects")
}

model Course {
  id          String   @id @default(uuid()) @db.Uuid
  centerId    String   @map("center_id") @db.Uuid
  name        String?
  subjectId   String   @map("subject_id") @db.Uuid
  maxStudents Int?     @map("max_students")
  status      String   @default("draft")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  classes     Class[]
  center      Center   @relation(fields: [centerId], references: [id])
  subject     Subject  @relation(fields: [subjectId], references: [id])

  @@map("courses")
}

model Class {
  id                String         @id @default(uuid()) @db.Uuid
  courseId          String         @map("course_id") @db.Uuid
  teacherId         String         @map("teacher_id") @db.Uuid
  roomId            String?        @map("room_id") @db.Uuid
  startDate         DateTime?      @map("start_date") @db.Date
  endDate           DateTime?      @map("end_date") @db.Date
  recurringSchedule Json?          @map("recurring_schedule")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  assessments       Assessment[]
  sessions          ClassSession[]
  course            Course         @relation(fields: [courseId], references: [id])
  room              Room?          @relation(fields: [roomId], references: [id])
  teacher           Teacher        @relation(fields: [teacherId], references: [id])
  enrollments       Enrollment[]
  materials         Material[]

  @@map("classes")
}

model ClassSession {
  id          String       @id @default(uuid()) @db.Uuid
  classId     String       @map("class_id") @db.Uuid
  sessionDate DateTime     @map("session_date") @db.Date
  startTime   DateTime     @map("start_time") @db.Time(6)
  endTime     DateTime     @map("end_time") @db.Time(6)
  roomId      String?      @map("room_id") @db.Uuid
  status      String       @default("scheduled")
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  attendances Attendance[]
  class       Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  room        Room?        @relation(fields: [roomId], references: [id])

  @@map("class_sessions")
}

model Enrollment {
  id         BigInt   @id @default(autoincrement())
  studentId  String   @map("student_id") @db.Uuid
  classId    String   @map("class_id") @db.Uuid
  enrolledAt DateTime @default(now()) @map("enrolled_at") @db.Timestamptz(6)
  status     String   @default("active")
  class      Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("enrollments")
}

model Room {
  id        String         @id @default(uuid()) @db.Uuid
  centerId  String         @map("center_id") @db.Uuid
  name      String?
  capacity  Int?
  createdAt DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  sessions  ClassSession[]
  classes   Class[]
  center    Center         @relation(fields: [centerId], references: [id])

  @@map("rooms")
}

model Attendance {
  id             BigInt       @id @default(autoincrement())
  sessionId      String       @map("session_id") @db.Uuid
  studentId      String       @map("student_id") @db.Uuid
  status         String
  note           String?
  recordedBy     String       @map("recorded_by") @db.Uuid
  recordedAt     DateTime     @default(now()) @map("recorded_at") @db.Timestamptz(6)
  recordedByUser User         @relation("RecordedBy", fields: [recordedBy], references: [id])
  session        ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendances")
}

model Assessment {
  id        String    @id @default(uuid()) @db.Uuid
  classId   String    @map("class_id") @db.Uuid
  name      String?
  type      String?
  maxScore  Decimal?  @map("max_score")
  date      DateTime? @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  class     Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  grades    Grade[]

  @@map("assessments")
}

model Grade {
  id           BigInt     @id @default(autoincrement())
  assessmentId String     @map("assessment_id") @db.Uuid
  studentId    String     @map("student_id") @db.Uuid
  score        Decimal?
  feedback     String?
  gradedBy     String     @map("graded_by") @db.Uuid
  gradedAt     DateTime   @default(now()) @map("graded_at") @db.Timestamptz(6)
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  gradedByUser User       @relation("GradedBy", fields: [gradedBy], references: [id])
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("grades")
}

model Material {
  id             BigInt   @id @default(autoincrement())
  classId        String   @map("class_id") @db.Uuid
  title          String?
  url            String?
  uploadedBy     String   @map("uploaded_by") @db.Uuid
  uploadedAt     DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  class          Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedByUser User     @relation("UploadedBy", fields: [uploadedBy], references: [id])

  @@map("materials")
}

model Notification {
  id            BigInt    @id @default(autoincrement())
  centerId      String    @map("center_id") @db.Uuid
  title         String?
  body          String?
  audience      Json?
  sentAt        DateTime? @map("sent_at") @db.Timestamptz(6)
  createdBy     String    @map("created_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  center        Center    @relation(fields: [centerId], references: [id])
  createdByUser User      @relation("CreatedBy", fields: [createdBy], references: [id])

  @@map("notifications")
}

model Alert {
  id          BigInt   @id @default(autoincrement())
  centerId    String   @map("center_id") @db.Uuid
  alertType   String   @map("alert_type")
  payload     Json?
  triggeredAt DateTime @default(now()) @map("triggered_at") @db.Timestamptz(6)
  processed   Boolean  @default(false)
  center      Center   @relation(fields: [centerId], references: [id])

  @@map("alerts")
}

model TeacherDocument {
  id         BigInt   @id @default(autoincrement())
  teacherId  String   @map("teacher_id") @db.Uuid
  docType    String?  @map("doc_type")
  docUrl     String?  @map("doc_url")
  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  teacher    Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("teacher_documents")
}

model Contract {
  id        BigInt    @id @default(autoincrement())
  teacherId String    @map("teacher_id") @db.Uuid
  startDate DateTime? @map("start_date") @db.Date
  endDate   DateTime? @map("end_date") @db.Date
  salary    Decimal?  @db.Decimal(12, 2)
  terms     Json?
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  teacher   Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("contracts")
}

model Payroll {
  id              BigInt    @id @default(autoincrement())
  teacherId       String    @map("teacher_id") @db.Uuid
  periodStart     DateTime  @map("period_start") @db.Date
  periodEnd       DateTime  @map("period_end") @db.Date
  amount          Decimal   @db.Decimal(12, 2)
  computedDetails Json?     @map("computed_details")
  paidAt          DateTime? @map("paid_at") @db.Timestamptz(6)
  teacher         Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("payrolls")
}
